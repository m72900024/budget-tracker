<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ˆç•«ç¶“è²»è¿½è¹¤ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: {
        colors: { primary: '#4f46e5', secondary: '#10b981', warning: '#f59e0b', danger: '#ef4444' },
        fontFamily: { sans: ['Inter', 'Noto Sans TC', 'sans-serif'] }
      }}
    }
  </script>
  <style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06); }
    .modal-backdrop { position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:50;opacity:0;pointer-events:none;transition:opacity .3s }
    .modal-backdrop.open { opacity:1;pointer-events:auto }
    .modal-backdrop.open .modal-box { transform:scale(1);opacity:1 }
    .modal-box { transform:scale(.95);opacity:0;transition:all .3s;max-height:90vh;overflow-y:auto }
    .progress-bar { transition: width 0.5s ease; }
    .toast { animation: slideIn .3s ease, fadeOut .3s ease 2.7s forwards; }
    @keyframes slideIn { from { transform: translateX(100%); opacity:0 } to { transform: translateX(0); opacity:1 } }
    @keyframes fadeOut { to { opacity:0; transform: translateX(50%) } }
    .cat-dragging { opacity: 0.5; }
    .cat-drag-over { border-color: #4f46e5 !important; background: #eef2ff !important; }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      .card-shadow { box-shadow: none !important; border: 1px solid #ddd !important; }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors">

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[999] space-y-2"></div>

  <div class="container mx-auto p-4 md:p-8 max-w-6xl">
    <!-- Header -->
    <header class="mb-8 no-print">
      <div class="flex justify-between items-center flex-wrap gap-3">
        <h1 class="text-3xl font-extrabold text-primary dark:text-indigo-400 flex items-center gap-2">ğŸ’° è¨ˆç•«ç¶“è²»è¿½è¹¤ç³»çµ±</h1>
        <div class="flex gap-2 flex-wrap">
          <button onclick="toggleDarkMode()" id="dark-toggle" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-3 rounded-lg text-sm transition">ğŸŒ™</button>
          <button onclick="showVendorModal()" class="bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 text-purple-700 dark:text-purple-300 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸª å» å•†</button>
          <button onclick="showTemplateModal()" class="bg-blue-100 dark:bg-blue-900 hover:bg-blue-200 text-blue-700 dark:text-blue-300 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“‹ æ¨¡æ¿</button>
          <button onclick="printReport()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ–¨ï¸ åˆ—å°</button>
          <button onclick="exportCSV()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“Š CSV</button>
          <button onclick="exportAll()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“¤ åŒ¯å‡º</button>
          <button onclick="importAll()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“¥ åŒ¯å…¥</button>
          <input type="file" id="import-file" accept=".json" class="hidden">
        </div>
      </div>
      <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">ç®¡ç†å„é …è¨ˆç•«é ç®—èˆ‡æ ¸éŠ·é€²åº¦</p>
    </header>

    <!-- ===== é¢æ¿ ===== -->
    <div id="dashboard-view">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">è¨ˆç•«æ•¸</p>
          <p id="stat-projects" class="text-3xl font-extrabold text-primary dark:text-indigo-400">0</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">ç¸½é ç®—</p>
          <p id="stat-budget" class="text-3xl font-extrabold text-secondary">0</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">å·²æ ¸éŠ·</p>
          <p id="stat-used" class="text-3xl font-extrabold text-warning">0</p>
        </div>
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">å‰©é¤˜</p>
          <p id="stat-remain" class="text-3xl font-extrabold text-danger">0</p>
        </div>
      </div>

      <!-- åœ“é¤…åœ– + æœå°‹ -->
      <div class="flex flex-col md:flex-row gap-4 mb-6 no-print">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl card-shadow flex-shrink-0">
          <canvas id="pie-chart" width="180" height="180"></canvas>
        </div>
        <div class="flex-1 space-y-3">
          <input type="text" id="dashboard-search" placeholder="ğŸ” æœå°‹è¨ˆç•«åç¨±..." class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg" oninput="renderDashboard()">
          <!-- å¹´åº¦ç¯©é¸ -->
          <div class="flex gap-2 flex-wrap" id="year-tags"></div>
        </div>
      </div>

      <div id="project-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

      <div class="mt-6 text-center no-print">
        <button onclick="showAddProjectModal()" class="bg-primary hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl text-lg transition shadow-lg">ï¼‹ æ–°å¢è¨ˆç•«</button>
      </div>
    </div>

    <!-- ===== è¨ˆç•«è©³æƒ… ===== -->
    <div id="detail-view" class="hidden">
      <button onclick="backToDashboard()" class="mb-4 text-primary dark:text-indigo-400 hover:underline font-bold flex items-center gap-1 no-print">â† å›åˆ°ç¸½è¦½</button>

      <div class="bg-white dark:bg-gray-800 p-6 rounded-xl card-shadow mb-6">
        <div class="flex justify-between items-start flex-wrap gap-3">
          <div>
            <h2 id="detail-title" class="text-2xl font-extrabold text-gray-800 dark:text-white"></h2>
            <p id="detail-desc" class="text-gray-500 dark:text-gray-400 mt-1"></p>
            <p id="detail-deadline" class="text-sm mt-1"></p>
          </div>
          <div class="flex gap-2 no-print">
            <button onclick="editCurrentProject()" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded-lg text-sm transition">âœï¸ ç·¨è¼¯</button>
            <button onclick="deleteCurrentProject()" class="bg-red-100 dark:bg-red-900 hover:bg-red-200 text-danger font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex justify-between text-sm mb-1">
            <span id="detail-used-label" class="text-gray-600 dark:text-gray-300"></span>
            <span id="detail-remain-label" class="text-gray-600 dark:text-gray-300"></span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
            <div id="detail-progress" class="progress-bar bg-primary rounded-full h-4"></div>
          </div>
        </div>
      </div>

      <div id="categories-list" class="space-y-4"></div>

      <div class="mt-4 no-print">
        <button onclick="showAddCategoryModal()" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg transition">ï¼‹ æ–°å¢ç¶“è²»é¡åˆ¥</button>
      </div>
    </div>
  </div>

  <!-- Modal: è¨ˆç•« -->
  <div id="modal-project" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-project-title" class="text-xl font-bold dark:text-white mb-4">æ–°å¢è¨ˆç•«</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è¨ˆç•«åç¨±</label>
          <input type="text" id="inp-project-name" placeholder="ä¾‹ï¼šæ•¸ä½å­¸ç¿’è¨ˆç•«" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" onkeydown="if(event.key==='Enter')saveProject()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-project-desc" placeholder="ä¾‹ï¼š112å¹´åº¦æ•™è‚²éƒ¨è£œåŠ©" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å¹´åº¦/å­¸æœŸï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-project-year" placeholder="ä¾‹ï¼š114å­¸å¹´" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">çµæ¡ˆæœŸé™ï¼ˆé¸å¡«ï¼‰</label>
          <input type="date" id="inp-project-deadline" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveProject()" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: ç¶“è²»é¡åˆ¥ -->
  <div id="modal-category" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-category-title" class="text-xl font-bold dark:text-white mb-4">æ–°å¢ç¶“è²»é¡åˆ¥</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é¡åˆ¥åç¨±</label>
          <input type="text" id="inp-cat-name" placeholder="ä¾‹ï¼šäººäº‹è²»" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é ç®—é‡‘é¡</label>
          <input type="number" step="0.1" id="inp-cat-budget" placeholder="50000" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" onkeydown="if(event.key==='Enter')saveCategory()">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveCategory()" class="flex-1 bg-secondary hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: æ ¸éŠ·é …ç›® -->
  <div id="modal-expense" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-expense-title" class="text-xl font-bold dark:text-white mb-4">æ–°å¢æ ¸éŠ·é …ç›®</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é …ç›®åç¨±</label>
          <input type="text" id="inp-exp-name" placeholder="ä¾‹ï¼šè¬›å¸«é˜é»è²»" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">é‡‘é¡</label>
          <input type="number" step="0.1" id="inp-exp-amount" placeholder="3000" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å» å•†</label>
          <div class="flex gap-2">
            <select id="inp-exp-vendor" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg"><option value="">-- ä¸æŒ‡å®š --</option></select>
            <button onclick="quickAddVendor()" class="bg-purple-100 dark:bg-purple-900 hover:bg-purple-200 text-purple-700 dark:text-purple-300 font-bold px-3 rounded-lg text-sm transition">ï¼‹</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ—¥æœŸ</label>
          <input type="date" id="inp-exp-date" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ”¶æ“šç·¨è™Ÿï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-exp-receipt" placeholder="ä¾‹ï¼šA-001" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ ¸éŠ·ç‹€æ…‹</label>
          <select id="inp-exp-status" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
            <option value="pending">â³ å¾…æ ¸éŠ·</option>
            <option value="submitted">ğŸ“ å·²é€ä»¶</option>
            <option value="approved">âœ… å·²æ ¸éŠ·</option>
            <option value="rejected">âŒ é€€ä»¶</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-exp-note" class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveExpense()" class="flex-1 bg-warning hover:bg-amber-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: å» å•†ç®¡ç† -->
  <div id="modal-vendor" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 class="text-xl font-bold dark:text-white mb-4">ğŸª å» å•†ç®¡ç†</h3>
      <div class="flex gap-2 mb-4">
        <input type="text" id="inp-vendor-name" placeholder="å» å•†åç¨±" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" onkeydown="if(event.key==='Enter')addVendor()">
        <button onclick="addVendor()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 rounded-lg transition">æ–°å¢</button>
      </div>
      <div id="vendor-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
      <div class="mt-4">
        <button onclick="closeAllModals()" class="w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-lg transition">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- Modal: è¨ˆç•«æ¨¡æ¿ -->
  <div id="modal-template" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 class="text-xl font-bold dark:text-white mb-4">ğŸ“‹ å¾æ¨¡æ¿å»ºç«‹è¨ˆç•«</h3>
      <div id="template-list" class="space-y-3"></div>
      <div class="mt-4">
        <button onclick="closeAllModals()" class="w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 text-gray-700 dark:text-gray-200 font-bold py-3 rounded-lg transition">é—œé–‰</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'budget-tracker-data';
    let data = { projects: [], vendors: [] };
    let currentProjectId = null;
    let editingProjectId = null;
    let editingCategoryId = null;
    let editingExpenseInfo = null;
    let collapsedCats = new Set();
    let yearFilter = '';

    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function load() { const r = localStorage.getItem(STORAGE_KEY); if(r) try { data=JSON.parse(r); if(!data.vendors)data.vendors=[]; data.projects.forEach(p=>{if(!p.year)p.year='';if(!p.deadline)p.deadline=''}); } catch(e){} }
    function fmt(n) { return Number(n).toLocaleString('zh-TW', {minimumFractionDigits:0, maximumFractionDigits:1}); }

    const statusMap = {
      pending: { label:'â³ å¾…æ ¸éŠ·', color:'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300' },
      submitted: { label:'ğŸ“ å·²é€ä»¶', color:'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' },
      approved: { label:'âœ… å·²æ ¸éŠ·', color:'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' },
      rejected: { label:'âŒ é€€ä»¶', color:'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' }
    };

    // ===== Toast =====
    function toast(msg, type='success') {
      const c = document.getElementById('toast-container');
      const colors = { success:'bg-green-500', error:'bg-red-500', warning:'bg-yellow-500', info:'bg-blue-500' };
      const div = document.createElement('div');
      div.className = `toast ${colors[type]||colors.info} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-bold`;
      div.textContent = msg;
      c.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    // ===== è¨ˆç®— =====
    function calcCat(cat) { const u=cat.expenses.reduce((s,e)=>s+(e.amount||0),0); return {budget:cat.budget||0,used:u,remain:(cat.budget||0)-u}; }
    function calcProj(proj) { let b=0,u=0; proj.categories.forEach(c=>{const r=calcCat(c);b+=r.budget;u+=r.used}); return {budget:b,used:u,remain:b-u,percent:b>0?Math.round(u/b*100):0}; }
    function calcAll() { let b=0,u=0; data.projects.forEach(p=>{const c=calcProj(p);b+=c.budget;u+=c.used}); return {budget:b,used:u,remain:b-u}; }

    // ===== æ·±è‰²æ¨¡å¼ =====
    window.toggleDarkMode = function() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('dark-mode', document.documentElement.classList.contains('dark'));
      document.getElementById('dark-toggle').textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
    };
    if(localStorage.getItem('dark-mode')==='true') { document.documentElement.classList.add('dark'); }

    // ===== åœ“é¤…åœ– =====
    function drawPie() {
      const canvas = document.getElementById('pie-chart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      const size = 180, cx = size/2, cy = size/2, r = 70;
      ctx.clearRect(0,0,size,size);
      
      const slices = [];
      data.projects.forEach(p => {
        const c = calcProj(p);
        if(c.budget > 0) slices.push({ name: p.name, value: c.budget, used: c.used });
      });
      
      if(slices.length === 0) {
        ctx.fillStyle = '#e5e7eb';
        ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = '#9ca3af'; ctx.font = '14px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('å°šç„¡è³‡æ–™', cx, cy+5);
        return;
      }

      const total = slices.reduce((s,d)=>s+d.value, 0);
      const colors = ['#4f46e5','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1'];
      let angle = -Math.PI/2;

      slices.forEach((s,i) => {
        const sweep = (s.value/total) * Math.PI * 2;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,angle,angle+sweep); ctx.closePath();
        ctx.fillStyle = colors[i % colors.length]; ctx.fill();
        // Label
        if(sweep > 0.3) {
          const mid = angle + sweep/2;
          const lx = cx + Math.cos(mid) * (r * 0.65);
          const ly = cy + Math.sin(mid) * (r * 0.65);
          ctx.fillStyle = 'white'; ctx.font = 'bold 11px sans-serif'; ctx.textAlign = 'center';
          ctx.fillText(Math.round(s.value/total*100)+'%', lx, ly+4);
        }
        angle += sweep;
      });
    }

    // ===== å¹´åº¦ç¯©é¸ =====
    function renderYearTags() {
      const years = [...new Set(data.projects.map(p=>p.year).filter(y=>y))];
      const container = document.getElementById('year-tags');
      if(!container) return;
      container.innerHTML = '';
      if(years.length === 0) return;
      
      const allBtn = document.createElement('button');
      allBtn.className = `px-3 py-1 rounded-full text-xs font-bold transition ${!yearFilter ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300'}`;
      allBtn.textContent = 'å…¨éƒ¨';
      allBtn.onclick = () => { yearFilter=''; renderDashboard(); };
      container.appendChild(allBtn);

      years.sort().forEach(y => {
        const btn = document.createElement('button');
        btn.className = `px-3 py-1 rounded-full text-xs font-bold transition ${yearFilter===y ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-300'}`;
        btn.textContent = y;
        btn.onclick = () => { yearFilter=y; renderDashboard(); };
        container.appendChild(btn);
      });
    }

    // ===== é¢æ¿æ¸²æŸ“ =====
    function renderDashboard() {
      const all = calcAll();
      document.getElementById('stat-projects').textContent = data.projects.length;
      document.getElementById('stat-budget').textContent = '$'+fmt(all.budget);
      document.getElementById('stat-used').textContent = '$'+fmt(all.used);
      document.getElementById('stat-remain').textContent = '$'+fmt(all.remain);

      renderYearTags();
      drawPie();

      const container = document.getElementById('project-cards');
      container.innerHTML = '';
      const search = (document.getElementById('dashboard-search')?.value||'').toLowerCase();
      const filtered = data.projects.filter(p => {
        if(search && !p.name.toLowerCase().includes(search) && !(p.desc||'').toLowerCase().includes(search)) return false;
        if(yearFilter && p.year !== yearFilter) return false;
        return true;
      });

      if(filtered.length===0) {
        container.innerHTML = data.projects.length===0
          ? '<div class="col-span-full text-center py-12 text-gray-400"><p class="text-5xl mb-4">ğŸ“‹</p><p class="text-lg">å°šç„¡è¨ˆç•«ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p></div>'
          : '<div class="col-span-full text-center py-8 text-gray-400"><p class="text-lg">æ‰¾ä¸åˆ°ç¬¦åˆçš„è¨ˆç•«</p></div>';
        return;
      }

      filtered.forEach(proj => {
        const c = calcProj(proj);
        const catCount = proj.categories.length;
        const expCount = proj.categories.reduce((s,cat)=>s+cat.expenses.length,0);
        let approvedAmt=0, pendingAmt=0;
        proj.categories.forEach(cat=>cat.expenses.forEach(e=>{if(e.status==='approved')approvedAmt+=(e.amount||0);else pendingAmt+=(e.amount||0);}));
        const progressColor = c.percent>90?'bg-danger':c.percent>70?'bg-warning':'bg-primary';

        // æœŸé™è¨ˆç®—
        let deadlineHtml = '';
        if(proj.deadline) {
          const days = Math.ceil((new Date(proj.deadline)-new Date())/(1000*60*60*24));
          if(days<0) deadlineHtml = `<span class="text-xs text-danger font-bold">âš ï¸ å·²é€¾æœŸ ${-days} å¤©</span>`;
          else if(days<=30) deadlineHtml = `<span class="text-xs text-warning font-bold">â° å‰© ${days} å¤©çµæ¡ˆ</span>`;
          else deadlineHtml = `<span class="text-xs text-gray-400">ğŸ“… ${proj.deadline}</span>`;
        }

        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl card-shadow hover:shadow-lg transition cursor-pointer transform hover:scale-[1.02]';
        card.onclick = () => openProject(proj.id);
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div>
              <h3 class="text-xl font-bold text-gray-800 dark:text-white">${proj.name}</h3>
              ${proj.year?`<span class="text-xs px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full">${proj.year}</span>`:''}
            </div>
            <span class="text-xs px-2 py-1 rounded-full ${c.percent>90?'bg-red-100 text-danger':c.percent>70?'bg-yellow-100 text-warning':'bg-green-100 text-secondary'} font-bold">${c.percent}%</span>
          </div>
          ${proj.desc?`<p class="text-sm text-gray-500 dark:text-gray-400 mb-1">${proj.desc}</p>`:''}
          ${deadlineHtml?`<div class="mb-2">${deadlineHtml}</div>`:''}
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 mb-3">
            <div class="progress-bar ${progressColor} rounded-full h-3" style="width:${Math.min(c.percent,100)}%"></div>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
            <div><p class="text-gray-400">é ç®—</p><p class="font-bold text-gray-800 dark:text-white">$${fmt(c.budget)}</p></div>
            <div><p class="text-gray-400">å·²ç”¨</p><p class="font-bold text-warning">$${fmt(c.used)}</p></div>
            <div><p class="text-gray-400">å‰©é¤˜</p><p class="font-bold ${c.remain<0?'text-danger':'text-secondary'}">$${fmt(c.remain)}</p></div>
          </div>
          <div class="mt-3 pt-3 border-t dark:border-gray-700 flex justify-between text-xs text-gray-400">
            <span>${catCount} å€‹é¡åˆ¥ Â· ${expCount} ç­†</span>
            <span>âœ…$${fmt(approvedAmt)} Â· â³$${fmt(pendingAmt)}</span>
          </div>`;
        container.appendChild(card);
      });
    }

    // ===== è¨ˆç•«è©³æƒ… =====
    function openProject(id) { currentProjectId=id; document.getElementById('dashboard-view').classList.add('hidden'); document.getElementById('detail-view').classList.remove('hidden'); renderDetail(); }
    function backToDashboard() { currentProjectId=null; document.getElementById('detail-view').classList.add('hidden'); document.getElementById('dashboard-view').classList.remove('hidden'); renderDashboard(); }
    function getProject(id) { return data.projects.find(p=>p.id===(id||currentProjectId)); }

    function renderDetail() {
      const proj=getProject(); if(!proj) return backToDashboard();
      const c=calcProj(proj);
      document.getElementById('detail-title').textContent=proj.name;
      document.getElementById('detail-desc').textContent=proj.desc||'';
      
      // æœŸé™
      const dlEl = document.getElementById('detail-deadline');
      if(proj.deadline) {
        const days=Math.ceil((new Date(proj.deadline)-new Date())/(1000*60*60*24));
        if(days<0) dlEl.innerHTML=`<span class="text-danger font-bold">âš ï¸ å·²é€¾æœŸ ${-days} å¤©ï¼ˆæœŸé™ï¼š${proj.deadline}ï¼‰</span>`;
        else if(days<=30) dlEl.innerHTML=`<span class="text-warning font-bold">â° å‰© ${days} å¤©çµæ¡ˆï¼ˆæœŸé™ï¼š${proj.deadline}ï¼‰</span>`;
        else dlEl.innerHTML=`<span class="text-gray-500">ğŸ“… çµæ¡ˆæœŸé™ï¼š${proj.deadline}ï¼ˆå‰© ${days} å¤©ï¼‰</span>`;
      } else dlEl.textContent='';

      document.getElementById('detail-used-label').textContent=`å·²ç”¨ $${fmt(c.used)} / $${fmt(c.budget)}`;
      document.getElementById('detail-remain-label').textContent=`å‰©é¤˜ $${fmt(c.remain)} (${c.percent}%)`;
      document.getElementById('detail-progress').style.width=Math.min(c.percent,100)+'%';
      document.getElementById('detail-progress').className=`progress-bar rounded-full h-4 ${c.percent>90?'bg-danger':c.percent>70?'bg-warning':'bg-primary'}`;

      const list=document.getElementById('categories-list');
      list.innerHTML='';
      if(proj.categories.length===0) { list.innerHTML='<div class="text-center py-8 text-gray-400"><p class="text-lg">å°šç„¡ç¶“è²»é¡åˆ¥</p></div>'; return; }

      proj.categories.forEach((cat,catIdx) => {
        const cc=calcCat(cat);
        const pct=cc.budget>0?Math.round(cc.used/cc.budget*100):0;
        const progressColor=pct>90?'bg-danger':pct>70?'bg-warning':'bg-secondary';
        const isCollapsed = collapsedCats.has(cat.id);

        const div=document.createElement('div');
        div.className='bg-white dark:bg-gray-800 rounded-xl card-shadow overflow-hidden border-2 border-transparent';
        div.draggable=true;
        div.dataset.catId=cat.id;
        div.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain',cat.id); div.classList.add('cat-dragging'); });
        div.addEventListener('dragend', () => div.classList.remove('cat-dragging'));
        div.addEventListener('dragover', e => { e.preventDefault(); div.classList.add('cat-drag-over'); });
        div.addEventListener('dragleave', () => div.classList.remove('cat-drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault(); div.classList.remove('cat-drag-over');
          const fromId=e.dataTransfer.getData('text/plain');
          if(fromId===cat.id) return;
          const proj=getProject();
          const fromIdx=proj.categories.findIndex(c=>c.id===fromId);
          const toIdx=proj.categories.findIndex(c=>c.id===cat.id);
          if(fromIdx<0||toIdx<0) return;
          const [moved]=proj.categories.splice(fromIdx,1);
          proj.categories.splice(toIdx,0,moved);
          save(); renderDetail();
          toast('é¡åˆ¥é †åºå·²æ›´æ–°');
        });

        div.innerHTML=`
          <div class="p-5">
            <div class="flex justify-between items-center mb-2 cursor-pointer" onclick="toggleCat('${cat.id}')">
              <div class="flex items-center gap-2">
                <span class="text-gray-400 cursor-grab no-print" title="æ‹–æ‹‰æ’åº">â ¿</span>
                <span class="text-sm transition-transform ${isCollapsed?'':'rotate-90'}">${isCollapsed?'â–¶':'â–¼'}</span>
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">${cat.name}</h3>
              </div>
              <div class="flex gap-2 items-center">
                <span class="text-sm font-bold ${cc.remain<0?'text-danger':'text-secondary'}">å‰©é¤˜ $${fmt(cc.remain)} ${cc.remain<0?'âš ï¸è¶…æ”¯ï¼':''}</span>
                <button onclick="event.stopPropagation();editCategory('${cat.id}')" class="text-gray-400 hover:text-primary text-sm no-print">âœï¸</button>
                <button onclick="event.stopPropagation();deleteCategory('${cat.id}')" class="text-gray-400 hover:text-danger text-sm no-print">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mb-1">
              <span>$${fmt(cc.used)} / $${fmt(cc.budget)}</span>
              <span>${pct}%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-3">
              <div class="progress-bar ${progressColor} rounded-full h-2" style="width:${Math.min(pct,100)}%"></div>
            </div>
            <div class="${isCollapsed?'hidden':''}">
              <div class="space-y-2">
                ${cat.expenses.length===0?'<p class="text-sm text-gray-400 text-center py-2">å°šç„¡æ ¸éŠ·ç´€éŒ„</p>':
                  [...cat.expenses].sort((a,b)=>(b.date||'').localeCompare(a.date||'')).map(exp=>{
                    const st=statusMap[exp.status]||statusMap.pending;
                    return `<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-750 rounded-lg group">
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class="font-medium text-gray-800 dark:text-white">${exp.name}</span>
                          <span class="px-2 py-0.5 text-xs rounded-full ${st.color} font-bold">${st.label}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                          ${exp.date||''} ${exp.vendor?'Â· ğŸª'+exp.vendor:''} ${exp.receipt?'Â· #'+exp.receipt:''} ${exp.note?'Â· '+exp.note:''}
                        </div>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800 dark:text-white">$${fmt(exp.amount||0)}</span>
                        <div class="flex gap-1 md:opacity-0 group-hover:opacity-100 transition-opacity no-print">
                          <button onclick="event.stopPropagation();duplicateExpense('${cat.id}','${exp.id}')" class="text-gray-400 hover:text-blue-500 text-xs" title="è¤‡è£½">ğŸ“‹</button>
                          <button onclick="event.stopPropagation();editExpense('${cat.id}','${exp.id}')" class="text-gray-400 hover:text-primary text-xs">âœï¸</button>
                          <button onclick="event.stopPropagation();deleteExpense('${cat.id}','${exp.id}')" class="text-gray-400 hover:text-danger text-xs">ğŸ—‘ï¸</button>
                        </div>
                      </div>
                    </div>`;
                  }).join('')}
              </div>
              <button onclick="showAddExpenseModal('${cat.id}')" class="mt-3 w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-400 hover:border-warning hover:text-warning transition text-sm font-bold no-print">ï¼‹ æ–°å¢æ ¸éŠ·é …ç›®</button>
            </div>
          </div>`;
        list.appendChild(div);
      });
    }

    window.toggleCat = function(catId) { if(collapsedCats.has(catId)) collapsedCats.delete(catId); else collapsedCats.add(catId); renderDetail(); };

    // ===== Modal =====
    function closeAllModals() { document.querySelectorAll('.modal-backdrop').forEach(m=>m.classList.remove('open')); }

    function showAddProjectModal() {
      editingProjectId=null;
      document.getElementById('modal-project-title').textContent='æ–°å¢è¨ˆç•«';
      ['inp-project-name','inp-project-desc','inp-project-year','inp-project-deadline'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('modal-project').classList.add('open');
      document.getElementById('inp-project-name').focus();
    }

    window.editCurrentProject = function() {
      const p=getProject(); if(!p) return;
      editingProjectId=p.id;
      document.getElementById('modal-project-title').textContent='ç·¨è¼¯è¨ˆç•«';
      document.getElementById('inp-project-name').value=p.name;
      document.getElementById('inp-project-desc').value=p.desc||'';
      document.getElementById('inp-project-year').value=p.year||'';
      document.getElementById('inp-project-deadline').value=p.deadline||'';
      document.getElementById('modal-project').classList.add('open');
    };

    window.saveProject = function() {
      const name=document.getElementById('inp-project-name').value.trim();
      if(!name) return toast('è«‹è¼¸å…¥è¨ˆç•«åç¨±','error');
      const desc=document.getElementById('inp-project-desc').value.trim();
      const year=document.getElementById('inp-project-year').value.trim();
      const deadline=document.getElementById('inp-project-deadline').value;
      if(editingProjectId) {
        const p=getProject(editingProjectId);
        if(p) Object.assign(p,{name,desc,year,deadline});
        toast('è¨ˆç•«å·²æ›´æ–°');
      } else {
        data.projects.push({id:uid(),name,desc,year,deadline,categories:[]});
        toast('è¨ˆç•«å·²å»ºç«‹');
      }
      save(); closeAllModals();
      if(currentProjectId) renderDetail();
      renderDashboard();
    };

    window.deleteCurrentProject = function() {
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨ˆç•«ï¼Ÿæ‰€æœ‰ç¶“è²»å’Œæ ¸éŠ·ç´€éŒ„éƒ½æœƒåˆªé™¤ï¼')) return;
      data.projects=data.projects.filter(p=>p.id!==currentProjectId);
      save(); toast('è¨ˆç•«å·²åˆªé™¤','warning'); backToDashboard();
    };

    // --- é¡åˆ¥ ---
    function showAddCategoryModal() {
      editingCategoryId=null;
      document.getElementById('modal-category-title').textContent='æ–°å¢ç¶“è²»é¡åˆ¥';
      document.getElementById('inp-cat-name').value='';
      document.getElementById('inp-cat-budget').value='';
      document.getElementById('modal-category').classList.add('open');
      document.getElementById('inp-cat-name').focus();
    }

    window.editCategory = function(catId) {
      const p=getProject(); const cat=p?.categories.find(c=>c.id===catId); if(!cat) return;
      editingCategoryId=catId;
      document.getElementById('modal-category-title').textContent='ç·¨è¼¯ç¶“è²»é¡åˆ¥';
      document.getElementById('inp-cat-name').value=cat.name;
      document.getElementById('inp-cat-budget').value=cat.budget;
      document.getElementById('modal-category').classList.add('open');
    };

    window.saveCategory = function() {
      const name=document.getElementById('inp-cat-name').value.trim();
      const budget=parseFloat(document.getElementById('inp-cat-budget').value)||0;
      if(!name) return toast('è«‹è¼¸å…¥é¡åˆ¥åç¨±','error');
      const p=getProject(); if(!p) return;
      if(editingCategoryId) { const c=p.categories.find(c=>c.id===editingCategoryId); if(c){c.name=name;c.budget=budget;} toast('é¡åˆ¥å·²æ›´æ–°'); }
      else { p.categories.push({id:uid(),name,budget,expenses:[]}); toast('é¡åˆ¥å·²æ–°å¢'); }
      save(); closeAllModals(); renderDetail();
    };

    window.deleteCategory = function(catId) {
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿ')) return;
      const p=getProject(); if(p){p.categories=p.categories.filter(c=>c.id!==catId); save(); renderDetail(); toast('é¡åˆ¥å·²åˆªé™¤','warning');}
    };

    // --- æ ¸éŠ· ---
    function showAddExpenseModal(catId) {
      editingExpenseInfo={catId,expId:null};
      document.getElementById('modal-expense-title').textContent='æ–°å¢æ ¸éŠ·é …ç›®';
      document.getElementById('inp-exp-name').value='';
      document.getElementById('inp-exp-amount').value='';
      document.getElementById('inp-exp-date').value=new Date().toISOString().split('T')[0];
      document.getElementById('inp-exp-receipt').value='';
      document.getElementById('inp-exp-status').value='pending';
      document.getElementById('inp-exp-note').value='';
      refreshVendorDropdown();
      document.getElementById('inp-exp-vendor').value='';
      document.getElementById('modal-expense').classList.add('open');
      document.getElementById('inp-exp-name').focus();
    }

    window.editExpense = function(catId,expId) {
      const p=getProject(); const cat=p?.categories.find(c=>c.id===catId); const exp=cat?.expenses.find(e=>e.id===expId); if(!exp) return;
      editingExpenseInfo={catId,expId};
      document.getElementById('modal-expense-title').textContent='ç·¨è¼¯æ ¸éŠ·é …ç›®';
      document.getElementById('inp-exp-name').value=exp.name;
      document.getElementById('inp-exp-amount').value=exp.amount;
      document.getElementById('inp-exp-date').value=exp.date||'';
      document.getElementById('inp-exp-receipt').value=exp.receipt||'';
      document.getElementById('inp-exp-status').value=exp.status||'pending';
      document.getElementById('inp-exp-note').value=exp.note||'';
      refreshVendorDropdown();
      document.getElementById('inp-exp-vendor').value=exp.vendor||'';
      document.getElementById('modal-expense').classList.add('open');
    };

    window.duplicateExpense = function(catId,expId) {
      const p=getProject(); const cat=p?.categories.find(c=>c.id===catId); const exp=cat?.expenses.find(e=>e.id===expId); if(!exp) return;
      const newExp = {...exp, id:uid(), date:new Date().toISOString().split('T')[0], status:'pending'};
      cat.expenses.push(newExp);
      save(); renderDetail();
      toast(`å·²è¤‡è£½ã€Œ${exp.name}ã€ï¼Œç‹€æ…‹é‡è¨­ç‚ºå¾…æ ¸éŠ·`);
    };

    window.saveExpense = function() {
      const name=document.getElementById('inp-exp-name').value.trim();
      const amount=parseFloat(document.getElementById('inp-exp-amount').value)||0;
      if(!name) return toast('è«‹è¼¸å…¥é …ç›®åç¨±','error');
      if(!amount) return toast('è«‹è¼¸å…¥é‡‘é¡','error');
      const vendor=document.getElementById('inp-exp-vendor').value;
      const date=document.getElementById('inp-exp-date').value;
      const receipt=document.getElementById('inp-exp-receipt').value.trim();
      const status=document.getElementById('inp-exp-status').value;
      const note=document.getElementById('inp-exp-note').value.trim();
      const p=getProject(); const cat=p?.categories.find(c=>c.id===editingExpenseInfo?.catId); if(!cat) return;
      if(editingExpenseInfo.expId) { const e=cat.expenses.find(e=>e.id===editingExpenseInfo.expId); if(e) Object.assign(e,{name,amount,vendor,date,receipt,status,note}); toast('æ ¸éŠ·é …ç›®å·²æ›´æ–°'); }
      else { cat.expenses.push({id:uid(),name,amount,vendor,date,receipt,status,note}); toast('æ ¸éŠ·é …ç›®å·²æ–°å¢'); }
      save(); closeAllModals(); renderDetail();
    };

    window.deleteExpense = function(catId,expId) {
      if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
      const p=getProject(); const cat=p?.categories.find(c=>c.id===catId);
      if(cat){cat.expenses=cat.expenses.filter(e=>e.id!==expId); save(); renderDetail(); toast('å·²åˆªé™¤','warning');}
    };

    // ===== å» å•† =====
    function refreshVendorDropdown() {
      const s=document.getElementById('inp-exp-vendor'); const v=s.value;
      s.innerHTML='<option value="">-- ä¸æŒ‡å®š --</option>';
      data.vendors.forEach(v=>{ s.innerHTML+=`<option value="${v}">${v}</option>`; });
      s.value=v;
    }
    function renderVendorList() {
      const l=document.getElementById('vendor-list');
      if(!data.vendors.length){l.innerHTML='<p class="text-gray-400 text-center py-4">å°šç„¡å» å•†</p>';return;}
      l.innerHTML=data.vendors.map((v,i)=>`<div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><span class="font-medium text-gray-800 dark:text-white">ğŸª ${v}</span><div class="flex gap-1"><button onclick="renameVendor(${i})" class="text-gray-400 hover:text-primary text-sm">âœï¸</button><button onclick="deleteVendor(${i})" class="text-gray-400 hover:text-danger text-sm">ğŸ—‘ï¸</button></div></div>`).join('');
    }
    window.showVendorModal = function() { renderVendorList(); document.getElementById('inp-vendor-name').value=''; document.getElementById('modal-vendor').classList.add('open'); document.getElementById('inp-vendor-name').focus(); };
    window.addVendor = function() { const n=document.getElementById('inp-vendor-name').value.trim(); if(!n) return; if(data.vendors.includes(n)) return toast('æ­¤å» å•†å·²å­˜åœ¨','error'); data.vendors.push(n); data.vendors.sort((a,b)=>a.localeCompare(b,'zh-TW')); save(); document.getElementById('inp-vendor-name').value=''; renderVendorList(); refreshVendorDropdown(); toast('å» å•†å·²æ–°å¢'); };
    window.renameVendor = function(i) {
      const old=data.vendors[i]; const n=prompt('ä¿®æ”¹å» å•†åç¨±ï¼š',old); if(!n||!n.trim()||n.trim()===old) return;
      if(data.vendors.includes(n.trim())) return toast('åç¨±å·²å­˜åœ¨','error');
      let count=0; data.projects.forEach(p=>p.categories.forEach(c=>c.expenses.forEach(e=>{if(e.vendor===old){e.vendor=n.trim();count++;}})));
      data.vendors[i]=n.trim(); data.vendors.sort((a,b)=>a.localeCompare(b,'zh-TW'));
      save(); renderVendorList(); refreshVendorDropdown(); if(currentProjectId)renderDetail();
      toast(`å·²æ›´æ–°ï¼ŒåŒæ­¥ä¿®æ”¹ ${count} ç­†ç´€éŒ„`);
    };
    window.deleteVendor = function(i) {
      const name=data.vendors[i]; let count=0;
      data.projects.forEach(p=>p.categories.forEach(c=>c.expenses.forEach(e=>{if(e.vendor===name)count++;})));
      if(!confirm(count>0?`ã€Œ${name}ã€æœ‰ ${count} ç­†ç´€éŒ„åœ¨ä½¿ç”¨ï¼Œç¢ºå®šåˆªé™¤ï¼Ÿ`:`ç¢ºå®šåˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) return;
      if(count>0) data.projects.forEach(p=>p.categories.forEach(c=>c.expenses.forEach(e=>{if(e.vendor===name)e.vendor='';})));
      data.vendors.splice(i,1); save(); renderVendorList(); refreshVendorDropdown(); if(currentProjectId)renderDetail(); toast('å» å•†å·²åˆªé™¤','warning');
    };
    window.quickAddVendor = function() {
      const n=prompt('è¼¸å…¥æ–°å» å•†åç¨±ï¼š'); if(!n||!n.trim()) return;
      if(data.vendors.includes(n.trim())){document.getElementById('inp-exp-vendor').value=n.trim();return;}
      data.vendors.push(n.trim()); data.vendors.sort((a,b)=>a.localeCompare(b,'zh-TW'));
      save(); refreshVendorDropdown(); document.getElementById('inp-exp-vendor').value=n.trim(); toast('å» å•†å·²æ–°å¢');
    };

    // ===== æ¨¡æ¿ =====
    const TEMPLATES = [
      { name: 'æ•™è‚²éƒ¨è£œåŠ©è¨ˆç•«', desc: 'æ•™è‚²éƒ¨è£œåŠ©ç¶“è²»', categories: [
        {name:'äººäº‹è²»',budget:50000},{name:'ç¶“å¸¸é–€',budget:30000},{name:'è³‡æœ¬é–€',budget:80000},{name:'é›œæ”¯',budget:10000}
      ]},
      { name: 'æ ¡å…§æ´»å‹•ç¶“è²»', desc: 'æ ¡å…§è‡ªç±Œæ´»å‹•', categories: [
        {name:'å ´åœ°è²»',budget:5000},{name:'ææ–™è²»',budget:10000},{name:'é¤è²»',budget:8000},{name:'äº¤é€šè²»',budget:5000},{name:'é›œæ”¯',budget:2000}
      ]},
      { name: 'æ ¡å¤–æ•™å­¸', desc: 'æˆ¶å¤–æ•™è‚²æ´»å‹•', categories: [
        {name:'ç§Ÿè»Šè²»',budget:30000},{name:'é–€ç¥¨/å ´åœ°è²»',budget:15000},{name:'ä¿éšªè²»',budget:5000},{name:'é¤è²»',budget:10000},{name:'é›œæ”¯',budget:3000}
      ]},
      { name: 'è³‡è¨Šè¨­å‚™æ¡è³¼', desc: 'è³‡è¨Šè¨­å‚™æ›´æ–°', categories: [
        {name:'ç¡¬é«”è¨­å‚™',budget:100000},{name:'è»Ÿé«”æˆæ¬Š',budget:30000},{name:'å®‰è£/ç¶­è­·',budget:10000}
      ]}
    ];

    window.showTemplateModal = function() {
      const list=document.getElementById('template-list');
      list.innerHTML=TEMPLATES.map((t,i)=>`
        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition" onclick="createFromTemplate(${i})">
          <h4 class="font-bold text-gray-800 dark:text-white">${t.name}</h4>
          <p class="text-sm text-gray-500 dark:text-gray-400">${t.desc}</p>
          <p class="text-xs text-gray-400 mt-1">${t.categories.map(c=>c.name).join(' Â· ')}</p>
        </div>
      `).join('');
      document.getElementById('modal-template').classList.add('open');
    };

    window.createFromTemplate = function(i) {
      const t=TEMPLATES[i];
      const proj = { id:uid(), name:t.name, desc:t.desc, year:'', deadline:'',
        categories: t.categories.map(c=>({id:uid(),name:c.name,budget:c.budget,expenses:[]}))
      };
      data.projects.push(proj);
      save(); closeAllModals(); renderDashboard();
      toast(`å·²å¾æ¨¡æ¿å»ºç«‹ã€Œ${t.name}ã€`);
      openProject(proj.id);
    };

    // ===== åŒ¯å‡º/åŒ¯å…¥ =====
    window.exportAll = function() {
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`budget-tracker-${new Date().toISOString().split('T')[0]}.json`; a.click();
      toast('JSON å·²åŒ¯å‡º');
    };
    window.importAll = function() { document.getElementById('import-file').click(); };
    document.getElementById('import-file').addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{ try { const d=JSON.parse(ev.target.result); if(!d.projects) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
        if(!confirm(`åŒ¯å…¥ ${d.projects.length} å€‹è¨ˆç•«ï¼Ÿ`)) return;
        data=d; if(!data.vendors)data.vendors=[]; save(); currentProjectId=null;
        document.getElementById('detail-view').classList.add('hidden');
        document.getElementById('dashboard-view').classList.remove('hidden');
        renderDashboard(); toast('åŒ¯å…¥æˆåŠŸ');
      } catch(err){toast('åŒ¯å…¥å¤±æ•—: '+err.message,'error');} };
      r.readAsText(f); e.target.value='';
    });

    window.exportCSV = function() {
      const rows = ['è¨ˆç•«,é¡åˆ¥,é …ç›®,é‡‘é¡,å» å•†,æ—¥æœŸ,æ”¶æ“š,ç‹€æ…‹,å‚™è¨»'];
      data.projects.forEach(p => p.categories.forEach(c => {
        if(c.expenses.length===0) rows.push(`"${p.name}","${c.name}","(ç„¡æ ¸éŠ·)",${c.budget},,,,é ç®—,`);
        c.expenses.forEach(e => {
          const st = statusMap[e.status]?.label || e.status;
          rows.push(`"${p.name}","${c.name}","${e.name}",${e.amount},"${e.vendor||''}","${e.date||''}","${e.receipt||''}","${st}","${e.note||''}"`);
        });
      }));
      const blob=new Blob(["\ufeff"+rows.join('\n')],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`budget-report-${new Date().toISOString().split('T')[0]}.csv`; a.click();
      toast('CSV å·²åŒ¯å‡º');
    };

    window.printReport = function() { window.print(); };

    // ===== å¿«æ·éµ =====
    document.addEventListener('keydown', e => { if(e.key==='Escape') closeAllModals(); });

    // ===== å•Ÿå‹• =====
    load();
    document.getElementById('dark-toggle').textContent = document.documentElement.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
    renderDashboard();
  </script>
</body>
</html>
