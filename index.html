<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨ˆç•«ç¶“è²»è¿½è¹¤ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: { primary: '#4f46e5', secondary: '#10b981', warning: '#f59e0b', danger: '#ef4444' },
        fontFamily: { sans: ['Inter', 'Noto Sans TC', 'sans-serif'] }
      }}
    }
  </script>
  <style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06); }
    .modal-backdrop { position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:50;opacity:0;pointer-events:none;transition:opacity .3s }
    .modal-backdrop.open { opacity:1;pointer-events:auto }
    .modal-backdrop.open .modal-box { transform:scale(1);opacity:1 }
    .modal-box { transform:scale(.95);opacity:0;transition:all .3s }
    .progress-bar { transition: width 0.5s ease; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="container mx-auto p-4 md:p-8 max-w-6xl">

    <!-- Header -->
    <header class="mb-8">
      <div class="flex justify-between items-center flex-wrap gap-3">
        <h1 class="text-3xl font-extrabold text-primary flex items-center gap-2">
          ğŸ’° è¨ˆç•«ç¶“è²»è¿½è¹¤ç³»çµ±
        </h1>
        <div class="flex gap-2">
          <button onclick="showVendorModal()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸª å» å•†ç®¡ç†</button>
          <button onclick="exportAll()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“¤ åŒ¯å‡º</button>
          <button onclick="importAll()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ“¥ åŒ¯å…¥</button>
          <input type="file" id="import-file" accept=".json" class="hidden">
        </div>
      </div>
      <p class="text-gray-500 text-sm mt-1">ç®¡ç†å„é …è¨ˆç•«é ç®—èˆ‡æ ¸éŠ·é€²åº¦</p>
    </header>

    <!-- é¢æ¿ï¼šè¨ˆç•«ç¸½è¦½ -->
    <div id="dashboard-view">
      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500">è¨ˆç•«æ•¸</p>
          <p id="stat-projects" class="text-3xl font-extrabold text-primary">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500">ç¸½é ç®—</p>
          <p id="stat-budget" class="text-3xl font-extrabold text-secondary">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500">å·²æ ¸éŠ·</p>
          <p id="stat-used" class="text-3xl font-extrabold text-warning">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl card-shadow text-center">
          <p class="text-sm text-gray-500">å‰©é¤˜</p>
          <p id="stat-remain" class="text-3xl font-extrabold text-danger">0</p>
        </div>
      </div>

      <!-- è¨ˆç•«å¡ç‰‡åˆ—è¡¨ -->
      <div id="project-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

      <!-- æ–°å¢è¨ˆç•«æŒ‰éˆ• -->
      <div class="mt-6 text-center">
        <button onclick="showAddProjectModal()" class="bg-primary hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl text-lg transition shadow-lg">
          ï¼‹ æ–°å¢è¨ˆç•«
        </button>
      </div>
    </div>

    <!-- è¨ˆç•«è©³æƒ…é  -->
    <div id="detail-view" class="hidden">
      <button onclick="backToDashboard()" class="mb-4 text-primary hover:underline font-bold flex items-center gap-1">â† å›åˆ°ç¸½è¦½</button>

      <div class="bg-white p-6 rounded-xl card-shadow mb-6">
        <div class="flex justify-between items-start flex-wrap gap-3">
          <div>
            <h2 id="detail-title" class="text-2xl font-extrabold text-gray-800"></h2>
            <p id="detail-desc" class="text-gray-500 mt-1"></p>
          </div>
          <div class="flex gap-2">
            <button onclick="editCurrentProject()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition">âœï¸ ç·¨è¼¯è¨ˆç•«</button>
            <button onclick="deleteCurrentProject()" class="bg-red-100 hover:bg-red-200 text-danger font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ—‘ï¸ åˆªé™¤</button>
          </div>
        </div>
        <!-- è¨ˆç•«ç¸½é€²åº¦ -->
        <div class="mt-4">
          <div class="flex justify-between text-sm mb-1">
            <span id="detail-used-label" class="text-gray-600"></span>
            <span id="detail-remain-label" class="text-gray-600"></span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div id="detail-progress" class="progress-bar bg-primary rounded-full h-4"></div>
          </div>
        </div>
      </div>

      <!-- ç¶“è²»é¡åˆ¥åˆ—è¡¨ -->
      <div id="categories-list" class="space-y-4"></div>

      <div class="mt-4">
        <button onclick="showAddCategoryModal()" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg transition">
          ï¼‹ æ–°å¢ç¶“è²»é¡åˆ¥
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: æ–°å¢/ç·¨è¼¯è¨ˆç•« -->
  <div id="modal-project" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-project-title" class="text-xl font-bold mb-4">æ–°å¢è¨ˆç•«</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">è¨ˆç•«åç¨±</label>
          <input type="text" id="inp-project-name" placeholder="ä¾‹ï¼šæ•¸ä½å­¸ç¿’è¨ˆç•«" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-project-desc" placeholder="ä¾‹ï¼š112å¹´åº¦æ•™è‚²éƒ¨è£œåŠ©" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveProject()" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: æ–°å¢/ç·¨è¼¯ç¶“è²»é¡åˆ¥ -->
  <div id="modal-category" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-category-title" class="text-xl font-bold mb-4">æ–°å¢ç¶“è²»é¡åˆ¥</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é¡åˆ¥åç¨±</label>
          <input type="text" id="inp-cat-name" placeholder="ä¾‹ï¼šäººäº‹è²»" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é ç®—é‡‘é¡</label>
          <input type="number" id="inp-cat-budget" placeholder="50000" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveCategory()" class="flex-1 bg-secondary hover:bg-emerald-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: æ–°å¢/ç·¨è¼¯æ ¸éŠ·é …ç›® -->
  <div id="modal-expense" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 id="modal-expense-title" class="text-xl font-bold mb-4">æ–°å¢æ ¸éŠ·é …ç›®</h3>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é …ç›®åç¨±</label>
          <input type="text" id="inp-exp-name" placeholder="ä¾‹ï¼šè¬›å¸«é˜é»è²»" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">é‡‘é¡</label>
          <input type="number" id="inp-exp-amount" placeholder="3000" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ—¥æœŸ</label>
          <input type="date" id="inp-exp-date" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å» å•†</label>
          <div class="flex gap-2">
            <select id="inp-exp-vendor" class="flex-1 p-3 border border-gray-300 rounded-lg bg-white">
              <option value="">-- ä¸æŒ‡å®š --</option>
            </select>
            <button onclick="quickAddVendor()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold px-3 rounded-lg text-sm transition" title="å¿«é€Ÿæ–°å¢å» å•†">ï¼‹</button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ”¶æ“š/å–®æ“šç·¨è™Ÿï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-exp-receipt" placeholder="ä¾‹ï¼šA-001" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">æ ¸éŠ·ç‹€æ…‹</label>
          <select id="inp-exp-status" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
            <option value="pending">â³ å¾…æ ¸éŠ·</option>
            <option value="submitted">ğŸ“ å·²é€ä»¶</option>
            <option value="approved">âœ… å·²æ ¸éŠ·</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="inp-exp-note" placeholder="" class="w-full p-3 border border-gray-300 rounded-lg">
        </div>
      </div>
      <div class="flex gap-2 mt-5">
        <button onclick="saveExpense()" class="flex-1 bg-warning hover:bg-amber-600 text-white font-bold py-3 rounded-lg transition">å„²å­˜</button>
        <button onclick="closeAllModals()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- Modal: å» å•†ç®¡ç† -->
  <div id="modal-vendor" class="modal-backdrop" onclick="if(event.target===this)closeAllModals()">
    <div class="modal-box bg-white rounded-xl shadow-2xl w-full max-w-md m-4 p-6">
      <h3 class="text-xl font-bold mb-4">ğŸª å» å•†ç®¡ç†</h3>
      <div class="flex gap-2 mb-4">
        <input type="text" id="inp-vendor-name" placeholder="å» å•†åç¨±" class="flex-1 p-3 border border-gray-300 rounded-lg" onkeydown="if(event.key==='Enter')addVendor()">
        <button onclick="addVendor()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 rounded-lg transition">æ–°å¢</button>
      </div>
      <div id="vendor-list" class="space-y-2 max-h-[50vh] overflow-y-auto"></div>
      <div class="mt-4">
        <button onclick="closeAllModals()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg transition">é—œé–‰</button>
      </div>
    </div>
  </div>

  <script>
    // ===== è³‡æ–™æ¨¡å‹ =====
    // å­˜åœ¨ localStorageï¼Œçµæ§‹ï¼š
    // { projects: [ { id, name, desc, categories: [ { id, name, budget, expenses: [ { id, name, amount, date, receipt, status, note } ] } ] } ] }

    const STORAGE_KEY = 'budget-tracker-data';
    let data = { projects: [], vendors: [] };
    let currentProjectId = null;
    let editingProjectId = null;
    let editingCategoryId = null;
    let editingExpenseInfo = null; // { catId, expId }

    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) { try { data = JSON.parse(raw); if (!data.vendors) data.vendors = []; } catch(e) {} }
    }
    function fmt(n) { return n.toLocaleString('zh-TW'); }

    const statusMap = {
      pending: { label: 'â³ å¾…æ ¸éŠ·', color: 'bg-gray-100 text-gray-600' },
      submitted: { label: 'ğŸ“ å·²é€ä»¶', color: 'bg-blue-100 text-blue-700' },
      approved: { label: 'âœ… å·²æ ¸éŠ·', color: 'bg-green-100 text-green-700' }
    };

    // ===== è¨ˆç®— =====
    function calcCategory(cat) {
      const used = cat.expenses.reduce((s, e) => s + (e.amount || 0), 0);
      return { budget: cat.budget || 0, used, remain: (cat.budget || 0) - used };
    }

    function calcProject(proj) {
      let budget = 0, used = 0;
      proj.categories.forEach(cat => {
        const c = calcCategory(cat);
        budget += c.budget;
        used += c.used;
      });
      return { budget, used, remain: budget - used, percent: budget > 0 ? Math.round(used / budget * 100) : 0 };
    }

    function calcAll() {
      let budget = 0, used = 0;
      data.projects.forEach(p => {
        const c = calcProject(p);
        budget += c.budget;
        used += c.used;
      });
      return { budget, used, remain: budget - used };
    }

    // ===== é¢æ¿æ¸²æŸ“ =====
    function renderDashboard() {
      const all = calcAll();
      document.getElementById('stat-projects').textContent = data.projects.length;
      document.getElementById('stat-budget').textContent = '$' + fmt(all.budget);
      document.getElementById('stat-used').textContent = '$' + fmt(all.used);
      document.getElementById('stat-remain').textContent = '$' + fmt(all.remain);

      const container = document.getElementById('project-cards');
      container.innerHTML = '';

      if (data.projects.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400"><p class="text-5xl mb-4">ğŸ“‹</p><p class="text-lg">å°šç„¡è¨ˆç•«ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p></div>';
        return;
      }

      data.projects.forEach(proj => {
        const c = calcProject(proj);
        const catCount = proj.categories.length;
        const expCount = proj.categories.reduce((s, cat) => s + cat.expenses.length, 0);
        const progressColor = c.percent > 90 ? 'bg-danger' : c.percent > 70 ? 'bg-warning' : 'bg-primary';

        const card = document.createElement('div');
        card.className = 'bg-white p-6 rounded-xl card-shadow hover:shadow-lg transition cursor-pointer transform hover:scale-[1.02]';
        card.onclick = () => openProject(proj.id);
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <h3 class="text-xl font-bold text-gray-800">${proj.name}</h3>
            <span class="text-xs px-2 py-1 rounded-full ${c.percent > 90 ? 'bg-red-100 text-danger' : c.percent > 70 ? 'bg-yellow-100 text-warning' : 'bg-green-100 text-secondary'} font-bold">
              ${c.percent}%
            </span>
          </div>
          ${proj.desc ? `<p class="text-sm text-gray-500 mb-3">${proj.desc}</p>` : ''}
          <div class="w-full bg-gray-200 rounded-full h-3 mb-3">
            <div class="progress-bar ${progressColor} rounded-full h-3" style="width:${c.percent}%"></div>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center text-sm">
            <div><p class="text-gray-400">é ç®—</p><p class="font-bold text-gray-800">$${fmt(c.budget)}</p></div>
            <div><p class="text-gray-400">å·²ç”¨</p><p class="font-bold text-warning">$${fmt(c.used)}</p></div>
            <div><p class="text-gray-400">å‰©é¤˜</p><p class="font-bold ${c.remain < 0 ? 'text-danger' : 'text-secondary'}">$${fmt(c.remain)}</p></div>
          </div>
          <div class="mt-3 pt-3 border-t flex justify-between text-xs text-gray-400">
            <span>${catCount} å€‹é¡åˆ¥</span>
            <span>${expCount} ç­†æ ¸éŠ·</span>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ===== è¨ˆç•«è©³æƒ… =====
    function openProject(id) {
      currentProjectId = id;
      document.getElementById('dashboard-view').classList.add('hidden');
      document.getElementById('detail-view').classList.remove('hidden');
      renderDetail();
    }

    function backToDashboard() {
      currentProjectId = null;
      document.getElementById('detail-view').classList.add('hidden');
      document.getElementById('dashboard-view').classList.remove('hidden');
      renderDashboard();
    }

    function getProject(id) { return data.projects.find(p => p.id === (id || currentProjectId)); }

    function renderDetail() {
      const proj = getProject();
      if (!proj) return backToDashboard();
      const c = calcProject(proj);

      document.getElementById('detail-title').textContent = proj.name;
      document.getElementById('detail-desc').textContent = proj.desc || '';
      document.getElementById('detail-used-label').textContent = `å·²ç”¨ $${fmt(c.used)} / $${fmt(c.budget)}`;
      document.getElementById('detail-remain-label').textContent = `å‰©é¤˜ $${fmt(c.remain)} (${c.percent}%)`;
      document.getElementById('detail-progress').style.width = c.percent + '%';
      document.getElementById('detail-progress').className = `progress-bar rounded-full h-4 ${c.percent > 90 ? 'bg-danger' : c.percent > 70 ? 'bg-warning' : 'bg-primary'}`;

      const list = document.getElementById('categories-list');
      list.innerHTML = '';

      if (proj.categories.length === 0) {
        list.innerHTML = '<div class="text-center py-8 text-gray-400"><p class="text-lg">å°šç„¡ç¶“è²»é¡åˆ¥ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢</p></div>';
        return;
      }

      proj.categories.forEach(cat => {
        const cc = calcCategory(cat);
        const pct = cc.budget > 0 ? Math.round(cc.used / cc.budget * 100) : 0;
        const progressColor = pct > 90 ? 'bg-danger' : pct > 70 ? 'bg-warning' : 'bg-secondary';

        const div = document.createElement('div');
        div.className = 'bg-white rounded-xl card-shadow overflow-hidden';
        div.innerHTML = `
          <div class="p-5">
            <div class="flex justify-between items-center mb-2">
              <h3 class="text-lg font-bold text-gray-800">${cat.name}</h3>
              <div class="flex gap-2 items-center">
                <span class="text-sm font-bold ${cc.remain < 0 ? 'text-danger' : 'text-secondary'}">å‰©é¤˜ $${fmt(cc.remain)}</span>
                <button onclick="event.stopPropagation();editCategory('${cat.id}')" class="text-gray-400 hover:text-primary text-sm">âœï¸</button>
                <button onclick="event.stopPropagation();deleteCategory('${cat.id}')" class="text-gray-400 hover:text-danger text-sm">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="flex justify-between text-xs text-gray-400 mb-1">
              <span>$${fmt(cc.used)} / $${fmt(cc.budget)}</span>
              <span>${pct}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
              <div class="progress-bar ${progressColor} rounded-full h-2" style="width:${pct}%"></div>
            </div>

            <!-- æ ¸éŠ·æ˜ç´° -->
            <div class="space-y-2">
              ${cat.expenses.length === 0 ? '<p class="text-sm text-gray-400 text-center py-2">å°šç„¡æ ¸éŠ·ç´€éŒ„</p>' :
                cat.expenses.map(exp => {
                  const st = statusMap[exp.status] || statusMap.pending;
                  return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg group">
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-gray-800">${exp.name}</span>
                          <span class="px-2 py-0.5 text-xs rounded-full ${st.color} font-bold">${st.label}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                          ${exp.date || ''} ${exp.vendor ? 'Â· ğŸª' + exp.vendor : ''} ${exp.receipt ? 'Â· #' + exp.receipt : ''} ${exp.note ? 'Â· ' + exp.note : ''}
                        </div>
                      </div>
                      <div class="flex items-center gap-3">
                        <span class="font-bold text-gray-800">$${fmt(exp.amount || 0)}</span>
                        <div class="hidden group-hover:flex gap-1">
                          <button onclick="event.stopPropagation();editExpense('${cat.id}','${exp.id}')" class="text-gray-400 hover:text-primary text-xs">âœï¸</button>
                          <button onclick="event.stopPropagation();deleteExpense('${cat.id}','${exp.id}')" class="text-gray-400 hover:text-danger text-xs">ğŸ—‘ï¸</button>
                        </div>
                      </div>
                    </div>`;
                }).join('')}
            </div>

            <button onclick="showAddExpenseModal('${cat.id}')" class="mt-3 w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-400 hover:border-warning hover:text-warning transition text-sm font-bold">
              ï¼‹ æ–°å¢æ ¸éŠ·é …ç›®
            </button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // ===== Modal æ§åˆ¶ =====
    function closeAllModals() {
      document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('open'));
    }

    function showAddProjectModal() {
      editingProjectId = null;
      document.getElementById('modal-project-title').textContent = 'æ–°å¢è¨ˆç•«';
      document.getElementById('inp-project-name').value = '';
      document.getElementById('inp-project-desc').value = '';
      document.getElementById('modal-project').classList.add('open');
      document.getElementById('inp-project-name').focus();
    }

    window.editCurrentProject = function() {
      const proj = getProject();
      if (!proj) return;
      editingProjectId = proj.id;
      document.getElementById('modal-project-title').textContent = 'ç·¨è¼¯è¨ˆç•«';
      document.getElementById('inp-project-name').value = proj.name;
      document.getElementById('inp-project-desc').value = proj.desc || '';
      document.getElementById('modal-project').classList.add('open');
    };

    window.saveProject = function() {
      const name = document.getElementById('inp-project-name').value.trim();
      if (!name) return alert('è«‹è¼¸å…¥è¨ˆç•«åç¨±');
      const desc = document.getElementById('inp-project-desc').value.trim();

      if (editingProjectId) {
        const proj = getProject(editingProjectId);
        if (proj) { proj.name = name; proj.desc = desc; }
      } else {
        data.projects.push({ id: uid(), name, desc, categories: [] });
      }
      save();
      closeAllModals();
      if (currentProjectId) renderDetail();
      renderDashboard();
    };

    window.deleteCurrentProject = function() {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¨ˆç•«ï¼Ÿæ‰€æœ‰ç¶“è²»é¡åˆ¥å’Œæ ¸éŠ·ç´€éŒ„éƒ½æœƒä¸€ä½µåˆªé™¤ï¼')) return;
      data.projects = data.projects.filter(p => p.id !== currentProjectId);
      save();
      backToDashboard();
    };

    // --- ç¶“è²»é¡åˆ¥ ---
    function showAddCategoryModal() {
      editingCategoryId = null;
      document.getElementById('modal-category-title').textContent = 'æ–°å¢ç¶“è²»é¡åˆ¥';
      document.getElementById('inp-cat-name').value = '';
      document.getElementById('inp-cat-budget').value = '';
      document.getElementById('modal-category').classList.add('open');
      document.getElementById('inp-cat-name').focus();
    }

    window.editCategory = function(catId) {
      const proj = getProject();
      const cat = proj?.categories.find(c => c.id === catId);
      if (!cat) return;
      editingCategoryId = catId;
      document.getElementById('modal-category-title').textContent = 'ç·¨è¼¯ç¶“è²»é¡åˆ¥';
      document.getElementById('inp-cat-name').value = cat.name;
      document.getElementById('inp-cat-budget').value = cat.budget;
      document.getElementById('modal-category').classList.add('open');
    };

    window.saveCategory = function() {
      const name = document.getElementById('inp-cat-name').value.trim();
      const budget = parseInt(document.getElementById('inp-cat-budget').value) || 0;
      if (!name) return alert('è«‹è¼¸å…¥é¡åˆ¥åç¨±');

      const proj = getProject();
      if (!proj) return;

      if (editingCategoryId) {
        const cat = proj.categories.find(c => c.id === editingCategoryId);
        if (cat) { cat.name = name; cat.budget = budget; }
      } else {
        proj.categories.push({ id: uid(), name, budget, expenses: [] });
      }
      save();
      closeAllModals();
      renderDetail();
    };

    window.deleteCategory = function(catId) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿæ‰€æœ‰æ ¸éŠ·ç´€éŒ„éƒ½æœƒä¸€ä½µåˆªé™¤ï¼')) return;
      const proj = getProject();
      if (proj) { proj.categories = proj.categories.filter(c => c.id !== catId); save(); renderDetail(); }
    };

    // --- æ ¸éŠ·é …ç›® ---
    function showAddExpenseModal(catId) {
      editingExpenseInfo = null;
      document.getElementById('modal-expense-title').textContent = 'æ–°å¢æ ¸éŠ·é …ç›®';
      document.getElementById('inp-exp-name').value = '';
      document.getElementById('inp-exp-amount').value = '';
      document.getElementById('inp-exp-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('inp-exp-receipt').value = '';
      document.getElementById('inp-exp-status').value = 'pending';
      document.getElementById('inp-exp-note').value = '';
      editingExpenseInfo = { catId, expId: null };
      refreshVendorDropdown();
      document.getElementById('inp-exp-vendor').value = '';
      document.getElementById('modal-expense').classList.add('open');
      document.getElementById('inp-exp-name').focus();
    }

    window.editExpense = function(catId, expId) {
      const proj = getProject();
      const cat = proj?.categories.find(c => c.id === catId);
      const exp = cat?.expenses.find(e => e.id === expId);
      if (!exp) return;
      editingExpenseInfo = { catId, expId };
      document.getElementById('modal-expense-title').textContent = 'ç·¨è¼¯æ ¸éŠ·é …ç›®';
      document.getElementById('inp-exp-name').value = exp.name;
      document.getElementById('inp-exp-amount').value = exp.amount;
      document.getElementById('inp-exp-date').value = exp.date || '';
      document.getElementById('inp-exp-receipt').value = exp.receipt || '';
      document.getElementById('inp-exp-status').value = exp.status || 'pending';
      document.getElementById('inp-exp-note').value = exp.note || '';
      refreshVendorDropdown();
      document.getElementById('inp-exp-vendor').value = exp.vendor || '';
      document.getElementById('modal-expense').classList.add('open');
    };

    window.saveExpense = function() {
      const name = document.getElementById('inp-exp-name').value.trim();
      const amount = parseInt(document.getElementById('inp-exp-amount').value) || 0;
      if (!name) return alert('è«‹è¼¸å…¥é …ç›®åç¨±');
      if (!amount) return alert('è«‹è¼¸å…¥é‡‘é¡');

      const vendor = document.getElementById('inp-exp-vendor').value;
      const date = document.getElementById('inp-exp-date').value;
      const receipt = document.getElementById('inp-exp-receipt').value.trim();
      const status = document.getElementById('inp-exp-status').value;
      const note = document.getElementById('inp-exp-note').value.trim();

      const proj = getProject();
      const cat = proj?.categories.find(c => c.id === editingExpenseInfo?.catId);
      if (!cat) return;

      if (editingExpenseInfo.expId) {
        const exp = cat.expenses.find(e => e.id === editingExpenseInfo.expId);
        if (exp) { Object.assign(exp, { name, amount, vendor, date, receipt, status, note }); }
      } else {
        cat.expenses.push({ id: uid(), name, amount, vendor, date, receipt, status, note });
      }
      save();
      closeAllModals();
      renderDetail();
    };

    window.deleteExpense = function(catId, expId) {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ ¸éŠ·ç´€éŒ„ï¼Ÿ')) return;
      const proj = getProject();
      const cat = proj?.categories.find(c => c.id === catId);
      if (cat) { cat.expenses = cat.expenses.filter(e => e.id !== expId); save(); renderDetail(); }
    };

    // ===== å» å•†ç®¡ç† =====
    function refreshVendorDropdown() {
      const select = document.getElementById('inp-exp-vendor');
      const currentVal = select.value;
      select.innerHTML = '<option value="">-- ä¸æŒ‡å®š --</option>';
      data.vendors.forEach(v => {
        select.innerHTML += `<option value="${v}">${v}</option>`;
      });
      select.value = currentVal;
    }

    function renderVendorList() {
      const list = document.getElementById('vendor-list');
      if (data.vendors.length === 0) {
        list.innerHTML = '<p class="text-gray-400 text-center py-4">å°šç„¡å» å•†</p>';
        return;
      }
      list.innerHTML = data.vendors.map((v, i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <span class="font-medium text-gray-800">ğŸª ${v}</span>
          <div class="flex gap-1">
            <button onclick="renameVendor(${i})" class="text-gray-400 hover:text-primary text-sm" title="æ”¹å">âœï¸</button>
            <button onclick="deleteVendor(${i})" class="text-gray-400 hover:text-danger text-sm" title="åˆªé™¤">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    window.showVendorModal = function() {
      renderVendorList();
      document.getElementById('inp-vendor-name').value = '';
      document.getElementById('modal-vendor').classList.add('open');
      document.getElementById('inp-vendor-name').focus();
    };

    window.addVendor = function() {
      const name = document.getElementById('inp-vendor-name').value.trim();
      if (!name) return;
      if (data.vendors.includes(name)) return alert('æ­¤å» å•†å·²å­˜åœ¨');
      data.vendors.push(name);
      data.vendors.sort((a, b) => a.localeCompare(b, 'zh-TW'));
      save();
      document.getElementById('inp-vendor-name').value = '';
      renderVendorList();
      refreshVendorDropdown();
    };

    window.renameVendor = function(index) {
      const oldName = data.vendors[index];
      const newName = prompt(`ä¿®æ”¹å» å•†åç¨±ï¼š`, oldName);
      if (!newName || !newName.trim() || newName.trim() === oldName) return;
      const trimmed = newName.trim();
      if (data.vendors.includes(trimmed)) return alert('æ­¤å» å•†åç¨±å·²å­˜åœ¨');
      // æ›´æ–°æ‰€æœ‰æ ¸éŠ·ç´€éŒ„ä¸­çš„å» å•†åç¨±
      let count = 0;
      data.projects.forEach(p => p.categories.forEach(c => c.expenses.forEach(e => {
        if (e.vendor === oldName) { e.vendor = trimmed; count++; }
      })));
      data.vendors[index] = trimmed;
      data.vendors.sort((a, b) => a.localeCompare(b, 'zh-TW'));
      save();
      renderVendorList();
      refreshVendorDropdown();
      if (currentProjectId) renderDetail();
      alert(`å·²æ›´æ–°å» å•†åç¨±ï¼ŒåŒæ­¥ä¿®æ”¹äº† ${count} ç­†æ ¸éŠ·ç´€éŒ„`);
    };

    window.deleteVendor = function(index) {
      const name = data.vendors[index];
      // æª¢æŸ¥æœ‰å¤šå°‘ç­†ç´€éŒ„åœ¨ç”¨
      let count = 0;
      data.projects.forEach(p => p.categories.forEach(c => c.expenses.forEach(e => {
        if (e.vendor === name) count++;
      })));
      const msg = count > 0
        ? `å» å•†ã€Œ${name}ã€ç›®å‰æœ‰ ${count} ç­†æ ¸éŠ·ç´€éŒ„åœ¨ä½¿ç”¨ã€‚\nåˆªé™¤å¾Œé€™äº›ç´€éŒ„çš„å» å•†æ¬„ä½æœƒè®Šæˆç©ºç™½ã€‚\nç¢ºå®šåˆªé™¤ï¼Ÿ`
        : `ç¢ºå®šåˆªé™¤å» å•†ã€Œ${name}ã€ï¼Ÿ`;
      if (!confirm(msg)) return;
      // æ¸…é™¤ç´€éŒ„ä¸­çš„å» å•†
      if (count > 0) {
        data.projects.forEach(p => p.categories.forEach(c => c.expenses.forEach(e => {
          if (e.vendor === name) e.vendor = '';
        })));
      }
      data.vendors.splice(index, 1);
      save();
      renderVendorList();
      refreshVendorDropdown();
      if (currentProjectId) renderDetail();
    };

    window.quickAddVendor = function() {
      const name = prompt('è¼¸å…¥æ–°å» å•†åç¨±ï¼š');
      if (!name || !name.trim()) return;
      if (data.vendors.includes(name.trim())) {
        document.getElementById('inp-exp-vendor').value = name.trim();
        return;
      }
      data.vendors.push(name.trim());
      data.vendors.sort((a, b) => a.localeCompare(b, 'zh-TW'));
      save();
      refreshVendorDropdown();
      document.getElementById('inp-exp-vendor').value = name.trim();
    };

    // ===== åŒ¯å‡º / åŒ¯å…¥ =====
    window.exportAll = function() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `budget-tracker-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    };

    window.importAll = function() {
      document.getElementById('import-file').click();
    };

    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const imported = JSON.parse(ev.target.result);
          if (!imported.projects) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
          if (!confirm(`åŒ¯å…¥ ${imported.projects.length} å€‹è¨ˆç•«ï¼Ÿé€™æœƒå–ä»£ç¾æœ‰è³‡æ–™ï¼`)) return;
          data = imported;
          save();
          currentProjectId = null;
          document.getElementById('detail-view').classList.add('hidden');
          document.getElementById('dashboard-view').classList.remove('hidden');
          renderDashboard();
        } catch (err) { alert('åŒ¯å…¥å¤±æ•—: ' + err.message); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // ===== å•Ÿå‹• =====
    load();
    renderDashboard();
  </script>
</body>
</html>
